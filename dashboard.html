<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Performance Analytics Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-dark: #003865;
    --primary-mid: #1a6bb5;
    --primary-accent: #00a3e0;
    --gold: #d4a843;
    --gold-light: #f0d68a;
    --surface: #f7f8fb;
    --surface-card: #ffffff;
    --text-primary: #1a1e2e;
    --text-secondary: #5a6178;
    --text-muted: #8b91a8;
    --border: #e4e7f0;
    --success: #2ecc71;
    --warning: #f39c12;
    --danger: #e74c3c;
    --radius: 14px;
    --shadow-sm: 0 1px 3px rgba(0,56,101,0.06);
    --shadow-md: 0 4px 20px rgba(0,56,101,0.08);
    --shadow-lg: 0 8px 40px rgba(0,56,101,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--surface);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ─── Header ─── */
  .header {
    background: linear-gradient(135deg, var(--primary-dark) 0%, #002244 60%, #001a33 100%);
    color: white;
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 30px rgba(0,0,0,0.15);
  }

  .header-inner {
    max-width: 1440px;
    margin: 0 auto;
    padding: 1.25rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.5rem;
  }

  .header-brand {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .header-logo {
    width: 44px;
    height: 44px;
    background: var(--gold);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Playfair Display', serif;
    font-weight: 800;
    font-size: 1.3rem;
    color: var(--primary-dark);
    flex-shrink: 0;
  }

  .header-text h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.35rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }

  .header-text p {
    font-size: 0.78rem;
    opacity: 0.7;
    font-weight: 300;
  }

  .header-meta {
    text-align: right;
    font-size: 0.75rem;
    opacity: 0.65;
    flex-shrink: 0;
  }

  /* ─── Navigation Tabs ─── */
  .nav-bar {
    background: white;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 72px;
    z-index: 99;
    box-shadow: var(--shadow-sm);
  }

  .nav-inner {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 2rem;
    display: flex;
    align-items: center;
    gap: 0;
    overflow-x: auto;
  }

  .nav-tab {
    padding: 0.85rem 1.3rem;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2.5px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    user-select: none;
  }

  .nav-tab:hover { color: var(--primary-dark); }
  .nav-tab.active {
    color: var(--primary-dark);
    border-bottom-color: var(--gold);
    font-weight: 600;
  }

  /* ─── Main Layout ─── */
  .main {
    max-width: 1440px;
    margin: 0 auto;
    padding: 1.5rem 2rem 3rem;
  }

  /* ─── Filters ─── */
  .filters-bar {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .filter-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .filter-select {
    padding: 0.5rem 2rem 0.5rem 0.85rem;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    color: var(--text-primary);
    background: white;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%235a6178' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    transition: border-color 0.2s;
  }

  .filter-select:hover { border-color: var(--primary-accent); }
  .filter-select:focus { outline: none; border-color: var(--primary-mid); box-shadow: 0 0 0 3px rgba(0,163,224,0.12); }

  /* ─── KPI Cards ─── */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .kpi-card {
    background: var(--surface-card);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .kpi-label {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 0.4rem;
  }

  .kpi-value {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-dark);
    line-height: 1.1;
  }

  .kpi-change {
    font-size: 0.75rem;
    margin-top: 0.3rem;
    font-weight: 500;
  }

  .kpi-change.up { color: var(--success); }
  .kpi-change.down { color: var(--danger); }
  .kpi-change.neutral { color: var(--text-muted); }

  /* ─── Chart Cards ─── */
  .charts-grid {
    display: grid;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .grid-2 { grid-template-columns: repeat(2, 1fr); }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .grid-1 { grid-template-columns: 1fr; }

  .chart-card {
    background: var(--surface-card);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }

  .chart-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .chart-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .chart-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.15rem;
  }

  .chart-badge {
    font-size: 0.68rem;
    padding: 0.25rem 0.6rem;
    border-radius: 20px;
    font-weight: 600;
    background: rgba(0,163,224,0.1);
    color: var(--primary-accent);
    white-space: nowrap;
  }

  .chart-container {
    position: relative;
    width: 100%;
  }

  .chart-container canvas {
    width: 100% !important;
  }

  /* ─── Tab Panels ─── */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ─── Data Table ─── */
  .data-table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }

  .data-table th {
    background: var(--primary-dark);
    color: white;
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
  }

  .data-table td {
    padding: 0.65rem 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
  }

  .data-table tr:hover td { background: rgba(0,163,224,0.04); }

  .data-table tr:last-child td { border-bottom: none; }

  .grade-badge {
    display: inline-block;
    padding: 0.15rem 0.55rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .grade-A { background: #d4edda; color: #155724; }
  .grade-B { background: #d1ecf1; color: #0c5460; }
  .grade-C { background: #fff3cd; color: #856404; }
  .grade-D { background: #f8d7da; color: #721c24; }

  /* ─── Footer ─── */
  .footer {
    text-align: center;
    padding: 2rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border);
    margin-top: 2rem;
  }

  .footer a { color: var(--primary-mid); text-decoration: none; }

  /* ─── Responsive ─── */
  @media (max-width: 1024px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .header-inner { flex-direction: column; text-align: center; }
    .header-meta { text-align: center; }
  }

  @media (max-width: 640px) {
    .main { padding: 1rem; }
    .kpi-row { grid-template-columns: repeat(2, 1fr); }
    .nav-tab { padding: 0.75rem 1rem; font-size: 0.78rem; }
    .header-inner { padding: 1rem; }
    .header-text h1 { font-size: 1.1rem; }
  }

  /* ─── Animations ─── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .kpi-card, .chart-card {
    animation: fadeUp 0.4s ease-out both;
  }

  .kpi-card:nth-child(1) { animation-delay: 0.05s; }
  .kpi-card:nth-child(2) { animation-delay: 0.1s; }
  .kpi-card:nth-child(3) { animation-delay: 0.15s; }
  .kpi-card:nth-child(4) { animation-delay: 0.2s; }
  .kpi-card:nth-child(5) { animation-delay: 0.25s; }
</style>
</head>
<body>

<!-- ═══════════ HEADER ═══════════ -->
<header class="header">
  <div class="header-inner">
    <div class="header-brand">
      <div class="header-logo">SP</div>
      <div class="header-text">
        <h1>Student Performance Analytics Dashboard</h1>
        <p>Undergraduate Programmes · Transnational Higher Education Context</p>
      </div>
    </div>
    <div class="header-meta">
      <div>Academic Years 2017–2025</div>
      <div>Last updated: Feb 2026</div>
    </div>
  </div>
</header>

<!-- ═══════════ NAVIGATION ═══════════ -->
<nav class="nav-bar">
  <div class="nav-inner">
    <div class="nav-tab active" data-tab="overview">Overview</div>
    <div class="nav-tab" data-tab="enrollment">Enrolment Trends</div>
    <div class="nav-tab" data-tab="performance">Academic Performance</div>
    <div class="nav-tab" data-tab="programmes">Programme Comparison</div>
    <div class="nav-tab" data-tab="attrition">Retention & Attrition</div>
    <div class="nav-tab" data-tab="data">Data Explorer</div>
  </div>
</nav>

<!-- ═══════════ MAIN CONTENT ═══════════ -->
<main class="main">

  <!-- Filters -->
  <div class="filters-bar">
    <span class="filter-label">Filters:</span>
    <select class="filter-select" id="filterYear">
      <option value="all">All Years</option>
    </select>
    <select class="filter-select" id="filterSchool">
      <option value="all">All Schools</option>
      <option value="business">Business</option>
      <option value="social_science">Social Science</option>
      <option value="natural_computing">Natural & Computing Sciences</option>
      <option value="legal">Legal Studies</option>
    </select>
    <select class="filter-select" id="filterLevel">
      <option value="all">All Levels</option>
      <option value="1">Level 1</option>
      <option value="2">Level 2</option>
      <option value="3">Level 3</option>
      <option value="4">Level 4 (Honours)</option>
    </select>
  </div>

  <!-- ═══ TAB: OVERVIEW ═══ -->
  <div class="tab-panel active" id="panel-overview">
    <div class="kpi-row" id="kpiRow"></div>
    <div class="charts-grid grid-2">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Enrolment by Academic Year</div><div class="chart-subtitle">Total student headcount per year</div></div>
          <div class="chart-badge">9-Year Trend</div>
        </div>
        <div class="chart-container"><canvas id="chartEnrolmentOverview"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Students by School</div><div class="chart-subtitle">Current distribution across schools</div></div>
          <div class="chart-badge">2024–25</div>
        </div>
        <div class="chart-container"><canvas id="chartSchoolDist"></canvas></div>
      </div>
    </div>
    <div class="charts-grid grid-2" style="margin-top:1.25rem">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Overall GPA Distribution</div><div class="chart-subtitle">Across all programmes and years</div></div>
        </div>
        <div class="chart-container"><canvas id="chartGPAOverview"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Degree Classification Outcomes</div><div class="chart-subtitle">Honours graduates, all cohorts</div></div>
        </div>
        <div class="chart-container"><canvas id="chartDegreeClass"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ═══ TAB: ENROLMENT ═══ -->
  <div class="tab-panel" id="panel-enrollment">
    <div class="charts-grid grid-1">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Enrolment Trends by School</div><div class="chart-subtitle">Stacked area — student numbers per school per year</div></div>
        </div>
        <div class="chart-container"><canvas id="chartEnrolmentSchool"></canvas></div>
      </div>
    </div>
    <div class="charts-grid grid-2" style="margin-top:1.25rem">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Gender Balance Over Time</div><div class="chart-subtitle">Percentage male vs female enrolment</div></div>
        </div>
        <div class="chart-container"><canvas id="chartGenderTrend"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">New Intake vs Continuing</div><div class="chart-subtitle">First-year entrants vs returning students</div></div>
        </div>
        <div class="chart-container"><canvas id="chartIntake"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ═══ TAB: PERFORMANCE ═══ -->
  <div class="tab-panel" id="panel-performance">
    <div class="charts-grid grid-2">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Mean GPA by Academic Year</div><div class="chart-subtitle">Weighted average across all programmes</div></div>
        </div>
        <div class="chart-container"><canvas id="chartGPATrend"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">GPA Distribution by School</div><div class="chart-subtitle">Box-style comparison (min, Q1, median, Q3, max)</div></div>
        </div>
        <div class="chart-container"><canvas id="chartGPABySchool"></canvas></div>
      </div>
    </div>
    <div class="charts-grid grid-2" style="margin-top:1.25rem">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Pass / Fail Rate by Year</div><div class="chart-subtitle">Percentage of students meeting progression criteria</div></div>
        </div>
        <div class="chart-container"><canvas id="chartPassFail"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Grade Band Breakdown</div><div class="chart-subtitle">CGS bands across all assessments</div></div>
        </div>
        <div class="chart-container"><canvas id="chartGradeBands"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ═══ TAB: PROGRAMMES ═══ -->
  <div class="tab-panel" id="panel-programmes">
    <div class="charts-grid grid-1">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Programme Performance Comparison</div><div class="chart-subtitle">Average GPA by programme — most recent academic year</div></div>
        </div>
        <div class="chart-container"><canvas id="chartProgPerf"></canvas></div>
      </div>
    </div>
    <div class="charts-grid grid-2" style="margin-top:1.25rem">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Enrolment Share by Programme</div><div class="chart-subtitle">Proportional student distribution</div></div>
        </div>
        <div class="chart-container"><canvas id="chartProgEnrol"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Progression Rate by Programme</div><div class="chart-subtitle">% students advancing to next level</div></div>
        </div>
        <div class="chart-container"><canvas id="chartProgProgression"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ═══ TAB: RETENTION ═══ -->
  <div class="tab-panel" id="panel-attrition">
    <div class="charts-grid grid-2">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Retention Rate by Cohort</div><div class="chart-subtitle">% of intake cohort still enrolled each year</div></div>
        </div>
        <div class="chart-container"><canvas id="chartRetention"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Withdrawal Reasons</div><div class="chart-subtitle">Aggregated across all years</div></div>
        </div>
        <div class="chart-container"><canvas id="chartWithdrawal"></canvas></div>
      </div>
    </div>
    <div class="charts-grid grid-1" style="margin-top:1.25rem">
      <div class="chart-card">
        <div class="chart-card-header">
          <div><div class="chart-title">Attrition Heatmap — School × Year</div><div class="chart-subtitle">Darker = higher dropout rate</div></div>
        </div>
        <div class="chart-container"><canvas id="chartAttritionHeat"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ═══ TAB: DATA EXPLORER ═══ -->
  <div class="tab-panel" id="panel-data">
    <div class="chart-card">
      <div class="chart-card-header">
        <div><div class="chart-title">Student-Level Data Sample</div><div class="chart-subtitle">First 50 records — filter using controls above</div></div>
        <div class="chart-badge" id="tableCount">2,500 Records</div>
      </div>
      <div class="data-table-wrapper">
        <table class="data-table" id="studentTable">
          <thead>
            <tr>
              <th>Student ID</th>
              <th>Programme</th>
              <th>School</th>
              <th>Level</th>
              <th>Year</th>
              <th>GPA</th>
              <th>Grade</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="studentTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<footer class="footer">
  <p>MSc Data Science Project — <strong>Building a Student Performance Analytics Dashboard for Strategic Decision-Making in Undergraduate Programme Management</strong></p>
  <p style="margin-top:0.3rem">Data generated for research purposes · Transnational higher education context · <a href="#">View on GitHub</a></p>
</footer>

<script>
// ══════════════════════════════════════════════════════
// DATA GENERATION — Realistic synthetic dataset
// ══════════════════════════════════════════════════════
const YEARS = ['2016-17','2017-18','2018-19','2019-20','2020-21','2021-22','2022-23','2023-24','2024-25'];
const SCHOOLS = {
  business: { name: 'Business School', color: '#003865', programmes: ['BA Business Management', 'BA Accounting & Finance', 'BA Marketing'] },
  social_science: { name: 'Social Science', color: '#00a3e0', programmes: ['MA Sociology', 'MA Psychology', 'MA International Relations'] },
  natural_computing: { name: 'Natural & Computing', color: '#2ecc71', programmes: ['BSc Computing Science', 'BSc Data Science'] },
  legal: { name: 'Legal Studies', color: '#d4a843', programmes: ['LLB Law', 'LLB Law with Management'] }
};
const ALL_PROGRAMMES = Object.values(SCHOOLS).flatMap(s => s.programmes);
const LEVELS = [1, 2, 3, 4];

// Seeded pseudo-random
let _seed = 42;
function seededRandom() { _seed = (_seed * 16807 + 0) % 2147483647; return (_seed - 1) / 2147483646; }
function randBetween(a, b) { return a + seededRandom() * (b - a); }
function randInt(a, b) { return Math.floor(randBetween(a, b + 1)); }
function pick(arr) { return arr[randInt(0, arr.length - 1)]; }

// Enrolment growth model
const baseEnrolment = { business: 80, social_science: 60, natural_computing: 35, legal: 25 };
const growthRates = { business: 0.06, social_science: 0.05, natural_computing: 0.09, legal: 0.04 };
// COVID dip in 2019-20 and 2020-21
function getEnrolment(school, yearIdx) {
  let base = baseEnrolment[school];
  let n = Math.round(base * Math.pow(1 + growthRates[school], yearIdx));
  if (yearIdx === 3) n = Math.round(n * 0.88); // COVID dip
  if (yearIdx === 4) n = Math.round(n * 0.92);
  return n;
}

// Generate students
const students = [];
let studentIdCounter = 100001;
YEARS.forEach((year, yi) => {
  Object.entries(SCHOOLS).forEach(([sKey, school]) => {
    const n = getEnrolment(sKey, yi);
    for (let i = 0; i < n; i++) {
      const prog = pick(school.programmes);
      const level = pick(LEVELS);
      const gender = seededRandom() > 0.45 ? 'Female' : 'Male';
      // GPA: school-dependent base + year improvement trend + noise
      const schoolBonus = sKey === 'business' ? 0 : sKey === 'natural_computing' ? 0.15 : sKey === 'legal' ? 0.1 : -0.05;
      const yearTrend = yi * 0.02;
      const levelEffect = level === 4 ? 0.2 : level === 3 ? 0.1 : 0;
      let gpa = 2.5 + schoolBonus + yearTrend + levelEffect + randBetween(-0.8, 0.8);
      gpa = Math.max(0.5, Math.min(4.0, gpa));
      gpa = Math.round(gpa * 100) / 100;

      const withdrawn = seededRandom() < (yi <= 4 ? 0.08 : 0.06);
      let status = withdrawn ? 'Withdrawn' : (gpa >= 1.5 ? 'Active' : 'Probation');
      if (level === 4 && !withdrawn && gpa >= 1.5) status = 'Graduated';

      students.push({
        id: 'S' + studentIdCounter++,
        programme: prog,
        school: sKey,
        schoolName: school.name,
        level, year, yearIdx: yi, gender, gpa, status
      });
    }
  });
});

// CGS Grade mapping
function cgsGrade(gpa) {
  if (gpa >= 3.5) return 'A';
  if (gpa >= 3.0) return 'B';
  if (gpa >= 2.0) return 'C';
  if (gpa >= 1.5) return 'D';
  return 'F';
}

function degreeClass(gpa) {
  if (gpa >= 3.7) return 'First Class';
  if (gpa >= 3.2) return 'Upper Second (2:1)';
  if (gpa >= 2.5) return 'Lower Second (2:2)';
  if (gpa >= 2.0) return 'Third Class';
  return 'Fail';
}

// ══════════════════════════════════════════════════════
// GLOBAL STATE
// ══════════════════════════════════════════════════════
let chartInstances = {};

function getFiltered() {
  const fy = document.getElementById('filterYear').value;
  const fs = document.getElementById('filterSchool').value;
  const fl = document.getElementById('filterLevel').value;
  return students.filter(s => {
    if (fy !== 'all' && s.year !== fy) return false;
    if (fs !== 'all' && s.school !== fs) return false;
    if (fl !== 'all' && s.level !== +fl) return false;
    return true;
  });
}

// ══════════════════════════════════════════════════════
// CHART THEME
// ══════════════════════════════════════════════════════
Chart.defaults.font.family = "'DM Sans', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#5a6178';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 16;
Chart.defaults.plugins.tooltip.backgroundColor = '#1a1e2e';
Chart.defaults.plugins.tooltip.cornerRadius = 8;
Chart.defaults.plugins.tooltip.padding = 10;
const SCHOOL_COLORS = ['#003865', '#00a3e0', '#2ecc71', '#d4a843'];
const SCHOOL_KEYS = ['business', 'social_science', 'natural_computing', 'legal'];
const SCHOOL_LABELS = ['Business', 'Social Science', 'Natural & Computing', 'Legal Studies'];

// ══════════════════════════════════════════════════════
// POPULATE YEAR FILTER
// ══════════════════════════════════════════════════════
const yearSel = document.getElementById('filterYear');
YEARS.forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; yearSel.appendChild(o); });

// ══════════════════════════════════════════════════════
// TAB NAVIGATION
// ══════════════════════════════════════════════════════
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    renderAll();
  });
});

// ══════════════════════════════════════════════════════
// FILTER CHANGE
// ══════════════════════════════════════════════════════
document.querySelectorAll('.filter-select').forEach(sel => sel.addEventListener('change', renderAll));

// ══════════════════════════════════════════════════════
// HELPER — destroy & create chart
// ══════════════════════════════════════════════════════
function makeChart(id, config) {
  if (chartInstances[id]) chartInstances[id].destroy();
  const ctx = document.getElementById(id);
  if (!ctx) return null;
  chartInstances[id] = new Chart(ctx, config);
  return chartInstances[id];
}

// ══════════════════════════════════════════════════════
// RENDER FUNCTIONS
// ══════════════════════════════════════════════════════

function renderKPIs() {
  const data = getFiltered();
  const totalStudents = data.length;
  const avgGPA = data.length ? (data.reduce((s, d) => s + d.gpa, 0) / data.length).toFixed(2) : '—';
  const passRate = data.length ? ((data.filter(d => d.gpa >= 1.5).length / data.length) * 100).toFixed(1) : '—';
  const graduated = data.filter(d => d.status === 'Graduated').length;
  const withdrawn = data.filter(d => d.status === 'Withdrawn').length;
  const withdrawalRate = data.length ? ((withdrawn / data.length) * 100).toFixed(1) : '—';

  document.getElementById('kpiRow').innerHTML = `
    <div class="kpi-card"><div class="kpi-label">Total Students</div><div class="kpi-value">${totalStudents.toLocaleString()}</div><div class="kpi-change neutral">Filtered dataset</div></div>
    <div class="kpi-card"><div class="kpi-label">Average GPA</div><div class="kpi-value">${avgGPA}</div><div class="kpi-change up">↑ On 4.0 scale</div></div>
    <div class="kpi-card"><div class="kpi-label">Pass Rate</div><div class="kpi-value">${passRate}%</div><div class="kpi-change ${+passRate >= 85 ? 'up' : 'down'}">GPA ≥ 1.5</div></div>
    <div class="kpi-card"><div class="kpi-label">Graduates</div><div class="kpi-value">${graduated.toLocaleString()}</div><div class="kpi-change neutral">Level 4 completers</div></div>
    <div class="kpi-card"><div class="kpi-label">Withdrawal Rate</div><div class="kpi-value">${withdrawalRate}%</div><div class="kpi-change ${+withdrawalRate <= 8 ? 'up' : 'down'}">${+withdrawalRate <= 8 ? '↓ Healthy' : '↑ Monitor'}</div></div>
  `;
}

function renderOverviewCharts() {
  // Enrolment by year
  const enrolByYear = YEARS.map(y => students.filter(s => s.year === y).length);
  makeChart('chartEnrolmentOverview', {
    type: 'bar',
    data: {
      labels: YEARS,
      datasets: [{
        label: 'Total Enrolment',
        data: enrolByYear,
        backgroundColor: YEARS.map((_, i) => i === YEARS.length - 1 ? '#d4a843' : '#003865'),
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: { y: { beginAtZero: true, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });

  // School distribution (latest year)
  const latestYear = YEARS[YEARS.length - 1];
  const schoolCounts = SCHOOL_KEYS.map(k => students.filter(s => s.year === latestYear && s.school === k).length);
  makeChart('chartSchoolDist', {
    type: 'doughnut',
    data: {
      labels: SCHOOL_LABELS,
      datasets: [{ data: schoolCounts, backgroundColor: SCHOOL_COLORS, borderWidth: 3, borderColor: '#fff' }]
    },
    options: {
      responsive: true,
      cutout: '60%',
      plugins: { legend: { position: 'bottom' }, datalabels: { display: false } }
    }
  });

  // GPA Distribution histogram
  const data = getFiltered();
  const bins = [0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0];
  const binLabels = bins.slice(0, -1).map((b, i) => `${b.toFixed(1)}–${bins[i+1].toFixed(1)}`);
  const binCounts = binLabels.map((_, i) => data.filter(s => s.gpa >= bins[i] && s.gpa < bins[i+1]).length);
  makeChart('chartGPAOverview', {
    type: 'bar',
    data: {
      labels: binLabels,
      datasets: [{
        label: 'Students',
        data: binCounts,
        backgroundColor: binLabels.map((_, i) => {
          const colors = ['#e74c3c','#e74c3c','#f39c12','#f0d68a','#00a3e0','#1a6bb5','#003865','#003865'];
          return colors[i] || '#003865';
        }),
        borderRadius: 4,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: { y: { beginAtZero: true, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });

  // Degree classification
  const grads = students.filter(s => s.status === 'Graduated');
  const classes = ['First Class', 'Upper Second (2:1)', 'Lower Second (2:2)', 'Third Class', 'Fail'];
  const classCounts = classes.map(c => grads.filter(s => degreeClass(s.gpa) === c).length);
  makeChart('chartDegreeClass', {
    type: 'pie',
    data: {
      labels: classes,
      datasets: [{ data: classCounts, backgroundColor: ['#003865', '#1a6bb5', '#00a3e0', '#f39c12', '#e74c3c'], borderWidth: 2, borderColor: '#fff' }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' }, datalabels: { display: false } }
    }
  });
}

function renderEnrolmentCharts() {
  // Stacked area by school
  const datasets = SCHOOL_KEYS.map((k, i) => ({
    label: SCHOOL_LABELS[i],
    data: YEARS.map(y => students.filter(s => s.year === y && s.school === k).length),
    backgroundColor: SCHOOL_COLORS[i] + '55',
    borderColor: SCHOOL_COLORS[i],
    borderWidth: 2,
    fill: true,
    tension: 0.3,
  }));
  makeChart('chartEnrolmentSchool', {
    type: 'line',
    data: { labels: YEARS, datasets },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, datalabels: { display: false } },
      scales: { y: { stacked: true, beginAtZero: true, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });

  // Gender trend
  const maleData = YEARS.map(y => { const ys = students.filter(s => s.year === y); return ys.length ? ((ys.filter(s => s.gender === 'Male').length / ys.length) * 100).toFixed(1) : 0; });
  const femaleData = YEARS.map(y => { const ys = students.filter(s => s.year === y); return ys.length ? ((ys.filter(s => s.gender === 'Female').length / ys.length) * 100).toFixed(1) : 0; });
  makeChart('chartGenderTrend', {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Female %', data: femaleData, borderColor: '#00a3e0', backgroundColor: '#00a3e022', fill: true, tension: 0.3 },
        { label: 'Male %', data: maleData, borderColor: '#003865', backgroundColor: '#00386522', fill: true, tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, datalabels: { display: false } },
      scales: { y: { min: 0, max: 100, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });

  // New intake vs continuing
  const newIntake = YEARS.map(y => students.filter(s => s.year === y && s.level === 1).length);
  const continuing = YEARS.map(y => students.filter(s => s.year === y && s.level > 1).length);
  makeChart('chartIntake', {
    type: 'bar',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'New Intake (L1)', data: newIntake, backgroundColor: '#d4a843', borderRadius: 4, borderSkipped: false },
        { label: 'Continuing (L2–4)', data: continuing, backgroundColor: '#003865', borderRadius: 4, borderSkipped: false }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, datalabels: { display: false } },
      scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, grid: { color: '#f0f1f5' } } }
    }
  });
}

function renderPerformanceCharts() {
  // GPA trend
  const meanGPA = YEARS.map(y => {
    const ys = students.filter(s => s.year === y);
    return ys.length ? +(ys.reduce((a, s) => a + s.gpa, 0) / ys.length).toFixed(2) : 0;
  });
  makeChart('chartGPATrend', {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [{
        label: 'Mean GPA',
        data: meanGPA,
        borderColor: '#003865',
        backgroundColor: '#00386522',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#d4a843',
        pointRadius: 5,
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: { y: { min: 1.5, max: 3.5, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });

  // GPA by school — floating bar (simulated box plot)
  const schoolStats = SCHOOL_KEYS.map(k => {
    const gpas = students.filter(s => s.school === k).map(s => s.gpa).sort((a, b) => a - b);
    const q1 = gpas[Math.floor(gpas.length * 0.25)];
    const median = gpas[Math.floor(gpas.length * 0.5)];
    const q3 = gpas[Math.floor(gpas.length * 0.75)];
    return { q1, median, q3 };
  });
  makeChart('chartGPABySchool', {
    type: 'bar',
    data: {
      labels: SCHOOL_LABELS,
      datasets: [
        { label: 'Q1–Q3 Range', data: schoolStats.map(s => [s.q1, s.q3]), backgroundColor: SCHOOL_COLORS.map(c => c + '88'), borderColor: SCHOOL_COLORS, borderWidth: 2, borderRadius: 4, borderSkipped: false },
        { label: 'Median', data: schoolStats.map(s => s.median), type: 'line', borderColor: '#e74c3c', pointBackgroundColor: '#e74c3c', pointRadius: 7, pointBorderColor: '#fff', pointBorderWidth: 2, showLine: false }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, datalabels: { display: false } },
      scales: { y: { min: 1, max: 4, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });

  // Pass / Fail
  const passData = YEARS.map(y => { const ys = students.filter(s => s.year === y); return ys.length ? +((ys.filter(s => s.gpa >= 1.5).length / ys.length) * 100).toFixed(1) : 0; });
  const failData = YEARS.map(y => { const ys = students.filter(s => s.year === y); return ys.length ? +((ys.filter(s => s.gpa < 1.5).length / ys.length) * 100).toFixed(1) : 0; });
  makeChart('chartPassFail', {
    type: 'bar',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Pass %', data: passData, backgroundColor: '#2ecc71', borderRadius: 4, borderSkipped: false },
        { label: 'Fail %', data: failData, backgroundColor: '#e74c3c', borderRadius: 4, borderSkipped: false }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, datalabels: { display: false } },
      scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, max: 100, grid: { color: '#f0f1f5' } } }
    }
  });

  // Grade bands
  const grades = ['A', 'B', 'C', 'D', 'F'];
  const gradeColors = ['#003865', '#1a6bb5', '#00a3e0', '#f39c12', '#e74c3c'];
  const data = getFiltered();
  const gradeCounts = grades.map(g => data.filter(s => cgsGrade(s.gpa) === g).length);
  makeChart('chartGradeBands', {
    type: 'doughnut',
    data: {
      labels: grades.map((g, i) => `Grade ${g}`),
      datasets: [{ data: gradeCounts, backgroundColor: gradeColors, borderWidth: 2, borderColor: '#fff' }]
    },
    options: {
      responsive: true,
      cutout: '55%',
      plugins: { legend: { position: 'bottom' }, datalabels: { display: false } }
    }
  });
}

function renderProgrammeCharts() {
  const latestYear = YEARS[YEARS.length - 1];

  // Programme GPA comparison
  const progGPAs = ALL_PROGRAMMES.map(p => {
    const ps = students.filter(s => s.programme === p && s.year === latestYear);
    return ps.length ? +(ps.reduce((a, s) => a + s.gpa, 0) / ps.length).toFixed(2) : 0;
  });
  const progColors = ALL_PROGRAMMES.map(p => {
    for (const [k, v] of Object.entries(SCHOOLS)) if (v.programmes.includes(p)) return SCHOOLS[k].color;
    return '#999';
  });
  makeChart('chartProgPerf', {
    type: 'bar',
    data: {
      labels: ALL_PROGRAMMES.map(p => p.replace('BA ', '').replace('MA ', '').replace('BSc ', '').replace('LLB ', '')),
      datasets: [{ label: 'Avg GPA', data: progGPAs, backgroundColor: progColors, borderRadius: 6, borderSkipped: false }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: { x: { min: 0, max: 4, grid: { color: '#f0f1f5' } }, y: { grid: { display: false } } }
    }
  });

  // Enrolment share
  const progCounts = ALL_PROGRAMMES.map(p => students.filter(s => s.programme === p && s.year === latestYear).length);
  makeChart('chartProgEnrol', {
    type: 'polarArea',
    data: {
      labels: ALL_PROGRAMMES.map(p => p.replace('BA ', '').replace('MA ', '').replace('BSc ', '').replace('LLB ', '')),
      datasets: [{ data: progCounts, backgroundColor: progColors.map(c => c + 'aa') }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'right', labels: { font: { size: 11 } } }, datalabels: { display: false } }
    }
  });

  // Progression rate
  const progRates = ALL_PROGRAMMES.map(p => {
    const ps = students.filter(s => s.programme === p && s.level < 4);
    return ps.length ? +((ps.filter(s => s.gpa >= 1.5 && s.status !== 'Withdrawn').length / ps.length) * 100).toFixed(1) : 0;
  });
  makeChart('chartProgProgression', {
    type: 'radar',
    data: {
      labels: ALL_PROGRAMMES.map(p => p.replace('BA ', '').replace('MA ', '').replace('BSc ', '').replace('LLB ', '')),
      datasets: [{
        label: 'Progression %',
        data: progRates,
        backgroundColor: '#00a3e033',
        borderColor: '#003865',
        borderWidth: 2,
        pointBackgroundColor: '#d4a843',
        pointRadius: 4,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: { r: { min: 60, max: 100, ticks: { stepSize: 10 } } }
    }
  });
}

function renderRetentionCharts() {
  // Retention by cohort (first 5 cohorts that could have 4+ years of data)
  const cohorts = YEARS.slice(0, 5);
  const retentionData = cohorts.map(cy => {
    const ci = YEARS.indexOf(cy);
    const cohortStudents = students.filter(s => s.year === cy && s.level === 1);
    const total = cohortStudents.length;
    return YEARS.slice(ci, ci + 4).map((_, offset) => {
      const retained = Math.round(total * Math.pow(0.88 + seededRandom() * 0.08, offset));
      return total ? +((retained / total) * 100).toFixed(1) : 0;
    });
  });
  makeChart('chartRetention', {
    type: 'line',
    data: {
      labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4'],
      datasets: cohorts.map((c, i) => ({
        label: c,
        data: retentionData[i],
        borderColor: ['#003865', '#1a6bb5', '#00a3e0', '#2ecc71', '#d4a843'][i],
        backgroundColor: 'transparent',
        tension: 0.3,
        borderWidth: 2,
      }))
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, datalabels: { display: false } },
      scales: { y: { min: 50, max: 100, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });

  // Withdrawal reasons
  const reasons = ['Financial', 'Academic', 'Personal', 'Transfer', 'Employment', 'Other'];
  const reasonCounts = [28, 22, 18, 14, 12, 6];
  makeChart('chartWithdrawal', {
    type: 'bar',
    data: {
      labels: reasons,
      datasets: [{ data: reasonCounts, backgroundColor: ['#e74c3c', '#f39c12', '#00a3e0', '#1a6bb5', '#2ecc71', '#999'], borderRadius: 6, borderSkipped: false }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: { x: { beginAtZero: true, grid: { color: '#f0f1f5' } }, y: { grid: { display: false } } }
    }
  });

  // Attrition heatmap — simulated with matrix-style bar chart
  const attritionData = SCHOOL_KEYS.map(k =>
    YEARS.map(y => {
      const ys = students.filter(s => s.school === k && s.year === y);
      return ys.length ? +((ys.filter(s => s.status === 'Withdrawn').length / ys.length) * 100).toFixed(1) : 0;
    })
  );
  makeChart('chartAttritionHeat', {
    type: 'bar',
    data: {
      labels: YEARS,
      datasets: SCHOOL_KEYS.map((k, i) => ({
        label: SCHOOL_LABELS[i],
        data: attritionData[i],
        backgroundColor: SCHOOL_COLORS[i] + 'cc',
        borderRadius: 3,
        borderSkipped: false,
      }))
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, datalabels: { display: false } },
      scales: { y: { beginAtZero: true, title: { display: true, text: 'Withdrawal Rate %' }, grid: { color: '#f0f1f5' } }, x: { grid: { display: false } } }
    }
  });
}

function renderDataTable() {
  const data = getFiltered().slice(0, 50);
  document.getElementById('tableCount').textContent = getFiltered().length.toLocaleString() + ' Records';
  const tbody = document.getElementById('studentTableBody');
  tbody.innerHTML = data.map(s => {
    const grade = cgsGrade(s.gpa);
    const gradeClass = grade === 'F' ? 'grade-D' : `grade-${grade}`;
    return `<tr>
      <td><strong>${s.id}</strong></td>
      <td>${s.programme}</td>
      <td>${s.schoolName}</td>
      <td>Level ${s.level}</td>
      <td>${s.year}</td>
      <td><strong>${s.gpa.toFixed(2)}</strong></td>
      <td><span class="grade-badge ${gradeClass}">${grade}</span></td>
      <td>${s.status}</td>
    </tr>`;
  }).join('');
}

// ══════════════════════════════════════════════════════
// MASTER RENDER
// ══════════════════════════════════════════════════════
function renderAll() {
  renderKPIs();
  const activeTab = document.querySelector('.nav-tab.active').dataset.tab;
  if (activeTab === 'overview') renderOverviewCharts();
  if (activeTab === 'enrollment') renderEnrolmentCharts();
  if (activeTab === 'performance') renderPerformanceCharts();
  if (activeTab === 'programmes') renderProgrammeCharts();
  if (activeTab === 'attrition') renderRetentionCharts();
  if (activeTab === 'data') renderDataTable();
}

// Initial render
renderAll();
</script>
</body>
</html>
